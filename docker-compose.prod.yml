services:
  gateway:
    image: nginx:alpine
    container_name: bazarzone-gateway
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./gateway/ssl:/etc/nginx/ssl
      - ./gateway/certbot/conf:/etc/letsencrypt
      - ./gateway/certbot/www:/var/www/certbot
    depends_on:
      - frontend

  frontend:
    image: bazarzone-frontend:latest
    container_name: bazarzone-frontend
    restart: always
    expose:
      - "80"

  api:
    image: bazarzone-api:latest
    container_name: bazarzone-api
    restart: always
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # App configuration
      - App__SelfUrl=https://api.bazar-zone.com
      - App__HealthUiCheckUrl=http://localhost:8080/health-status
      - App__CorsOrigins=https://bazar-zone.com,https://www.bazar-zone.com
      - App__RedirectAllowedUrls=https://bazar-zone.com,https://www.bazar-zone.com
      - AuthServer__Authority=https://api.bazar-zone.com
      - AuthServer__SwaggerClientId=BazarZone_Swagger
      # Use host.docker.internal to reach PostgreSQL on the VPS host
      - ConnectionStrings__Default=Host=host.docker.internal;Port=5432;Database=bazarZoneDb;User ID=postgres;Password=NN66LVNxf70unh4AMWll6;
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/app/bazarzone
    expose:
      - "8080"

  certbot:
    image: certbot/certbot
    container_name: bazarzone-certbot
    volumes:
      - ./gateway/certbot/conf:/etc/letsencrypt
      - ./gateway/certbot/www:/var/www/certbot
